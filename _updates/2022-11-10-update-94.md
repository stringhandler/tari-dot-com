---
layout: update
tag: Developer Update
date: 2022-11-10
author: Stringhandler
thumbnail: update-background.jpg
title: A First Look at Tari Contracts
class: subpage
---

## A First Look at Tari Contracts


This is the first of a series of blogposts on covering the progress of creating smart contracts on the Tari Digital Asset Network (DAN) layer. 

This week we'll look at the actual contract code that is written in Rust. At the moment, the functionality is exceedingly basic AND SUBJECT TO CHANGE DRASTICALLY,
so I wouldn't recommend anything other than experimental testing at this stage.

Let's look at a basic contract:

```rust
use tari_template_macros::template;

#[template]
mod counter {
    pub struct Counter {
        value: u32,
    }

    impl Counter {
        pub fn new() -> Self {
            Self { value: 0 }
        }

        pub fn value(&self) -> u32 {
            self.value
        }

        pub fn increase(&mut self) {
            self.value += 1;
        }
    }
}
```

The first thing you may notice is that there are no coins or tokens or NFTs here. The community is still testing out many strategies in order to 
find the most ergonomic and safe way of exposing these to developers.

The next thing you may notice is the `tari_template_macros` include at the top. There are a few dependencies you'll need to add to your `Cargo.toml` file.
The easiest way to get started with a contract is to use 
the `cargo-generate` template on [Github](https://github.com/tari-project/wasm-template). 

First, after making sure you have `rustc` and `cargo` installed, install `cargo-generate`:

```shell
cargo install cargo-generate
```

Then, in a folder of your choosing, run and type in a project name (e.g. CounterDemo):

```shell
$ cargo generate https://github.com/tari-project/wasm-template.git counter

 Favorite `https://github.com/tari-project/wasm-template.git` not found in config, using it as a git repository: https://github.com/tari-project/wasm-template.git

 Project Name : CounterDemo

Renaming project called `CounterDemo` to `counter-demo`...
 Destination: C:\projects\counter-demo ...
 Generating template ...
[ 1/12]   Done: .cargo\config
[ 2/12]   Done: .cargo
[ 3/12]   Done: .gitignore
[ 4/12]   Done: Cargo.toml
[ 5/12]   Done: package\Cargo.toml
[ 6/12]   Done: package\src\lib.rs
[ 7/12]   Done: package\src
[ 8/12]   Done: package
[ 9/12]   Done: tests\Cargo.toml
[10/12]   Done: tests\tests\test.rs
[11/12]   Done: tests\tests
[12/12]   Done: tests
 Moving generated files into: `C:\projects\counter-demo`...
 Initializing a fresh Git repository
 Done! New project created C:\projects\counter-demo

```

The actual contract is in `package\src\lib.rs`. There are also some integration tests scaffolded under `tests`. We won't go into those this week.

Let's run the tests first to make sure we've got everything installed.

```
$ cargo test

.....
    Finished test [unoptimized + debuginfo] target(s) in 16.38s
     Running tests\test.rs (target\debug\deps\test-10fba866873c5eef.exe)

running 1 test
test test::test_increment ... ok

test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 5.56s

```

The Tari DAN layer doesn't actually run Rust contracts though, each contract runs as a WASM in it's own sandbox of sorts. Before we can register this code on the base layer we need to compile it to WASM.


```rust
cd package
cargo build-wasm
```

> NOTE: The Rust code in `tests` does not compile to WASM because it depends on the Tari engine code that hosts and executes WASM contracts, so running `cargo build-wasm` in the root folder will fail.

> NOTE: The `build-wasm` command is a `cargo` alias defined in `.cargo/config`". If you are having trouble you can also run `cargo build --target=wasm32-unknown-unknown`
```toml
[alias]
build-wasm = "build --target=wasm32-unknown-unknown"
```

In the next step, we'll register this contract on the Tari base layer and invoke 
some methods on it.




## Deploying the contract

```shell
$ cargo run --bin tari_validator_node_cli -- -b . templates publish -p c:\projects\counter-demo\package

Template code path c:\projects\temp2\counter-demo\package
⏳️ Compiling template...
✅ Template compilation successful (WASM file size: 95435 bytes)

Choose an user-friendly name for the template (max 32 characters):
> counterdemo 

Template version: (Default: 0)
> 0                           

Compiled template WASM file location: c:\projects\counter-demo\package\target/wasm32-unknown-unknown/release/package.wasm
Please upload the file to a public web location and then paste the URL                                                         
WASM public URL (max 255 characters):                                                                                          
> http://localhost:8000/counter_demo.wasm                                                                                      

✅ Template registration submitted

The template address will be 4addd7d36790130fa2ffcfc52551e5018e91dd87050ce59d2f93a6b212f6542c
```

The validator node is not strictly required to run this step. It will actually pass it on 
to a `tari_console_wallet` connected by gRPC, but the `tari_validator_node_cli` exposes this 
method for convenience. It also recompiles the contract into WASM and determines its hash, which will be stored on the base layer and is used by validator nodes to determine if they have the correct WASM file.

The WASM needs to be hosted at a URL that all nodes can reach it. In this case, 
I am using `simple-http-server` to host the output directory on port 8000.

The template registration appears in the wallet as a normal transaction. 

```shell
┌Tari Console Wallet────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ Transactions │ Send │ Receive │ Contacts │ Network │ Events │ Log │ Notifications(24)                                             │
└───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
┌Balance────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│Available: 288018.943629 T (Time Locked: 16615.757352 T)         Pending Incoming: 22145.448812 T Pending Outgoing: 5529.713495 T  │
└───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
 Up↑/Down↓ select Tx (C) cancel selected pending Txs (A) show/hide mining (R) rebroadcast Txs (Esc) exit list                     
┌Completed (T)ransactions (69) ─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│   Source/Destination Public Key                                    Amount/Token      Local Date/Time     Status                   │
│ 5eeee5ce53af80048b6e5d994aa52c639c79b8c503094d26dfe039fa20fe514a   0 µT              2022-11-10 15:35:24 Broadcast                │
│ 5eeee5ce53af80048b6e5d994aa52c639c79b8c503094d26dfe039fa20fe514a   5538.576052 T     2022-11-10 15:13:27 Mined Unconfirmed        │
│ 5eeee5ce53af80048b6e5d994aa52c639c79b8c503094d26dfe039fa20fe514a   5538.578485 T     2022-11-10 15:13:16 Mined Unconfirmed        │
│ 5eeee5ce53af80048b6e5d994aa52c639c79b8c503094d26dfe039fa20fe514a   5538.580918 T     2022-11-10 15:13:09 Mined Unconfirmed        │
│ 5eeee5ce53af80048b6e5d994aa52c639c79b8c503094d26dfe039fa20fe514a   5538.583351 T     2022-11-09 13:32:10 Mined Confirmed          │
│ 5eeee5ce53af80048b6e5d994aa52c639c79b8c503094d26dfe039fa20fe514a   5538.585784 T     2022-11-09 13:31:34 Mined Confirmed          │
└───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
 Base Node Status  -  Chain Tip: #111  Synced.  Latency 1659 ms                   Connected Base Node ID: e62a9cee9aa5532a399828151f 
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
 Network: igor             Version: 0.38.7           LeftArrow: Previous Tab  Tab/RightArrow: Next Tab              F10/Ctrl-Q: Quit 
 ```

 Next we can mine 4 blocks to satisfy the validator node's confirmation time (3 blocks).

```shell
# In the validator node logs:

16:15 [tari::validator_node::base_layer_scanner] INFO  ⛓️ Scanning base layer block 112 of 112
16:15 [tari::validator_node::base_layer_scanner] INFO  🌠 new template found with address 4addd7d36790130fa2ffcfc52551e5018e91dd87050ce59d2f93a6b212f6542c at height 112
16:15 [tari::validator_node::template_manager] INFO  ⏳️️ Template 4addd7d36790130fa2ffcfc52551e5018e91dd87050ce59d2f93a6b212f6542c queued for download
16:15 [reqwest::connect] DEBUG starting new connection: http://localhost:8000/
16:16 [tari::validator_node::template_manager] INFO  ✅ Template 4addd7d36790130fa2ffcfc52551e5018e91dd87050ce59d2f93a6b212f6542c downloaded successfully
16:16 [tari::validator_node::template_manager] INFO  ✅ Template 4addd7d36790130fa2ffcfc52551e5018e91dd87050ce59d2f93a6b212f6542c has status Active

```

We can list the templates (contracts) that the validator node has registered:

```shell

$ cargo run --bin tari_validator_node_cli -- -b . templates list                                             
    Finished dev [unoptimized + debuginfo] target(s) in 0.83s                                   
     Running `tari_validator_node_cli.exe -b . templates list`

Templates:
Address                                                          | Download Url                                                          | Mined Height | Status
---------------------------------------------------------------- | --------------------------------------------------------------------- | ------------ | ------
deb2a34c31891acac1e6b21a863b14953559c48be6c4f138e1d1a3e6971da6b0 | ... | 39           | Active
201ee40f24559f43d0bcc856614f63fc008573b2fcd4616436c4bd35d948323a | ... | 61           | Active
7ece3f243425916e47ad16cc8c4e10db8578df3b44e532c6e4e662123c3c8a83 | ... | 73           | Active
4addd7d36790130fa2ffcfc52551e5018e91dd87050ce59d2f93a6b212f6542c | http://localhost:8000/counter_demo.wasm                               | 112          | Active

4 row(s)
```

We can inspect the Application Binary Interface (ABI), or in other words the functions and methods exposed, 
using `templates get <template_address>`:

```shell
$ cargo run --bin tari_validator_node_cli -- -b . templates get 4addd7d36790130fa2ffcfc52551e5018e91dd87050ce59d2f93a6b212f6542c

    Finished dev [unoptimized + debuginfo] target(s) in 0.75s
     Running `tari_validator_node_cli.exe -b . templates get 4addd7d36790130fa2ffcfc52551e5018e91dd87050ce59d2f93a6b212f6542c`

Template 4addd7d36790130fa2ffcfc52551e5018e91dd87050ce59d2f93a6b212f6542c | Mined at 112

Function          | Args | Returns
----------------- | ---- | -------
Counter::new      |      | U32
Counter::value    | U32  | U32
Counter::increase | U32  | Unit

```

Invoking the commands. The first step is to create an instance of the contract on the DAN. We'll call `Counter::new` for that. This can be called many times, each time creating a new instance of Counter.


```shell

tari_validator_node_cli.exe -b . transactions submit -w -n 1 call-function 4addd7d36790130fa2ffcfc52551e5018e91dd87050ce59d2f93a6
b212f6542c new


✅ Transaction f31c90a8ae1f79473ef84e3c8eaeb03e831e6d034b9b7fac33a86166c5e01243 submitted.
⏳️ Waiting for transaction result...                                                     

✅️ Transaction finalized

Epoch: 11
Signed by: 2 validator nodes

========= Substates =========
️🌲 UP substate 391d01650715440c3b652a6e12919f3e9558d8727c1fdca51743a8b2ea4f591f (v0)
       ▶ component (Counter): 391d01650715440c3b652a6e12919f3e9558d8727c1fdca51743a8b2ea4f591f

========= Pledges =========
Shard:391d01650715440c3b652a6e12919f3e9558d8727c1fdca51743a8b2ea4f591f Pledge:DoesNotExist

========= Return Values =========
u32: 1694571833

========= LOGS =========
1668094546 DEBUG Dispatcher called with function new

OVERALL DECISION: Accept
```

Let's talk about this output for a bit. The transaction is hashed and signed and passed to the JSONRPC API of a validator node. You'll notice the `-w` which is short for `--wait-for-result` and `-n 1` which is short for `--number-of-outputs 1`. If you omit the `-w`, the transaction will be queued and processed and you'll need to query the
DAN at a later point to retrieve the result. At this point in time, you also need to specify the number of
outputs that this transaction will be creating. In the future, the Tari engine or validator node may be 
able to calculate this itself. For now, we can specify the output as 1. If you provide the wrong number, the 
transaction will not be processed.

In this example you can see that there is one substate at shard address 391d01650715440c3b652a6e12919f3e9558d8727c1fdca51743a8b2ea4f591f that will be brought up. Below the substates,
the shard addresses must be pledged. There should be one pledge for each substate that will be created, and one pledge for each input that will be consumed in this transaction. There are no inputs into this transaction, so we expect to see only one.

There is a return value and some logs that are generated, but these are not relevant here.

Finally, we have the overall decision, which was ACCEPT. This means that at least two thirds of validators in each 
committee for each shard address voted to accept this transaction and commit the substate data.

Next, let's call the `value` method.


```shell
tari_validator_node_cli.exe -b . transactions submit -w -n 0 call-method 4addd7d36790130fa2ffcfc52551e5018e91dd87050ce59d2f93a6b2
12f6542c 391d01650715440c3b652a6e12919f3e9558d8727c1fdca51743a8b2ea4f591f value


✅ Transaction 53c55e04ee4e94e2bde425725188010755215c3b93a77ecf7c26d2da1520533b submitted.
⏳️ Waiting for transaction result...

✅️ Transaction finalized

Epoch: 11
Payload height: NodeHeight(2)
Signed by: 2 validator nodes

========= Substates =========
========= Pledges =========
Shard:391d01650715440c3b652a6e12919f3e9558d8727c1fdca51743a8b2ea4f591f Pledge:Up

========= Return Values =========
u32: 0

========= LOGS =========
1668095320 DEBUG Dispatcher called with function value

OVERALL DECISION: Accept

```

In this case, we've specified 0 outputs, since it is a read transaction. At this point in time, even read only methods
go through consensus.

We also had to specify the `template_id` (4addd....) and the component_id (391d0...1f). The component id is the shard address of the substate component we created in the previous step. If you called `Counter::new` again, you would create
another substate. This component id allows us to identify which component we are interacting with.

The return value in this case is more important, we can see the value is 0.

Let's call `Counter::increase` now.

```shell

tari_validator_node_cli.exe -b . transactions submit -w -n 0 call-method 4addd7d36790130fa2ffcfc52551e5018e91dd87050ce59d2f93a6b2
12f6542c 391d01650715440c3b652a6e12919f3e9558d8727c1fdca51743a8b2ea4f591f increase



✅ Transaction ccbe0aad71cb89c584f965c241ed172a3edfb775959df3a54667fff90feab2e1 submitted.
⏳️ Waiting for transaction result...

✅️ Transaction finalized

Epoch: 11
Signed by: 2 validator nodes

========= Substates =========
️🌲 UP substate 391d01650715440c3b652a6e12919f3e9558d8727c1fdca51743a8b2ea4f591f (v1)
       ▶ component (Counter): 391d01650715440c3b652a6e12919f3e9558d8727c1fdca51743a8b2ea4f591f

🗑️ DOWN substate 391d01650715440c3b652a6e12919f3e9558d8727c1fdca51743a8b2ea4f591f

========= Pledges =========
Shard:391d01650715440c3b652a6e12919f3e9558d8727c1fdca51743a8b2ea4f591f Pledge:Up

========= Return Values =========

========= LOGS =========
1668095603 DEBUG Dispatcher called with function increase

OVERALL DECISION: Accept

```

Again we got an accept result. In this case there was a Down substate and an Up substate. You will see that 
they have the same shard address and that the version increased to 1. This is what we refer to as an Up-in-place. Note that this design may change significantly in future iterations.

Finally, let's call `Counter::value` to see if there was a change...

```shell

tari_validator_node_cli.exe -b . transactions submit -w -n 0 call-method 4addd7d36790130fa2ffcfc52551e5018e91dd87050ce59d2f93a6b2
12f6542c 391d01650715440c3b652a6e12919f3e9558d8727c1fdca51743a8b2ea4f591f value




✅ Transaction 18161023956be0f62f5b81e18cb59ce3a7a760e75247f8f0f635fe817fd10e45 submitted.
⏳️ Waiting for transaction result...

✅️ Transaction finalized

Epoch: 11
Signed by: 2 validator nodes

========= Substates =========
========= Pledges =========
Shard:391d01650715440c3b652a6e12919f3e9558d8727c1fdca51743a8b2ea4f591f Pledge:Up

========= Return Values =========
u32: 1

========= LOGS =========
1668095804 DEBUG Dispatcher called with function value

OVERALL DECISION: Accept

```

It returned 1! Well, that's all for now. Try it out...










